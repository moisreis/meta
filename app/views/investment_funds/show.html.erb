<%#
  # Partial: show.html.erb
  # Date: 12/1/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays a comprehensive dashboard view for a single InvestmentFund record.
  #              Shows fund details, portfolio allocations, valuation history, performance metrics,
  #              and recent transaction activity across all portfolios holding this fund.
  #
  # Usage:: - What: Renders the complete show view for the InvestmentFund resource with interactive
  #                 charts, portfolio breakdowns, valuation trends, and transaction history.
  #         - How: Accessed via GET /investment_funds/:id. Uses the **@investment_fund** instance variable
  #                loaded by **InvestmentFundsController#show** along with pre-calculated chart data.
  #         - Why: Provides users and administrators with a centralized dashboard to monitor fund
  #                performance, adoption across portfolios, pricing trends, and overall activity.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure consistency; it is used as the main
  #               container and works by setting the page title and descriptive CNPJ.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @investment_fund.fund_name,
           page_desc: "#{@investment_fund.cnpj}",
           current_view: "show" do
%>

  <%# Explanation:: This section groups the primary cadastral information for the fund
    #               to provide quick identification; it is used to display official records
    #               and works by creating a four-column grid with an edit action button.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Informações do Fundo",
             section_desc: "Dados cadastrais e identificação oficial",
             columns: 4,
             has_action: true,
             button_route: edit_investment_fund_path(@investment_fund),
             button_name: "Editar",
             button_icon: "pencil" do
  %>

    <%# Explanation:: This card displays the official tax ID (CNPJ) to ensure
      #               regulatory compliance; it is used to uniquely identify the fund
      #               and works by highlighting the number with a success theme.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "CNPJ",
               card_icon: "file-text",
               status: :teal do
    %>
      <%= normalize_code(@investment_fund.cnpj) %>
    <% end %>

    <%# Explanation:: This card identifies the institution responsible for managing
      #               the fund to clarify accountability; it is used for administrative
      #               tracking and works by rendering the administrator's name clearly.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Administrador",
               card_icon: "building-2" do
    %>
      <%= normalize_text(@investment_fund.administrator_name) %>
    <% end %>

    <%# Explanation:: This card shows the parent fund relationship to clarify the
      #               investment hierarchy; it is used for structural analysis and
      #               works by displaying the originator name or a placeholder if empty.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Fundo Originador",
               card_icon: "git-branch" do
    %>
      <%= normalize_text(@investment_fund.originator_fund.presence) %>
    <% end %>

    <%# Explanation:: This card highlights when the fund was first entered into
      #               the system to track operational history; it is used for record
      #               keeping and works by applying a standardized date format.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Cadastrado em",
               card_icon: "calendar-plus",
               card_data: normalize_card_time_ago(@investment_fund.created_at) do
    %>
      <%= normalize_date(@investment_fund.created_at) %>
    <% end %>
  <% end %>

  <%# Explanation:: This table lists all normative rules linked to this fund to
    #               ensure legal transparency; it is used for compliance checking
    #               and works by rendering article details and benchmarks in rows.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Artigos Normativos Vinculados",
             collection: @investment_fund.investment_fund_articles.includes(:normative_article),
             action_path: nil,
             action_name: nil,
             headers: ["Artigo", "Número", "Benchmark", "Observações"],
             column_icons: ["file-text", "hash", "target", "info"],
             body_procs: [
               ->(ifa) do
                 normalize_title(ifa.normative_article.display_name)
               end,
               ->(ifa) do
                 normalize_text(ifa.normative_article.article_number.presence)
               end,
               ->(ifa) do
                 normalize_percentage(ifa.normative_article.benchmark_target)
               end,
               ->(ifa) do
                 normalize_text(ifa.note.presence)
               end,
             ]
  %>

  <%# Explanation:: This section groups usage statistics to show how popular the
    #               fund is among users; it is used to track adoption rates and
    #               works by displaying active portfolios and total capital sums.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Métricas de Adoção",
             section_desc: "Estatísticas de uso do fundo em carteiras",
             columns: 4 do
  %>

    <%# Explanation:: This card counts how many unique portfolios hold this fund
      #               to measure reach; it is used to gauge popularity and works
      #               by performing a count on the associated portfolio records.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Carteiras Ativas",
               card_icon: "briefcase",
               status: :default do
    %>
      <%= normalize_number(@investment_fund.portfolios.count) %>
    <% end %>

    <%# Explanation:: This card displays the sum of all money currently invested
      #               in this fund to show its size; it is used for financial
      #               auditing and works by summing all linked allocation values.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Total Investido",
               card_icon: "banknote",
               status: :teal do
    %>
      <%= normalize_currency(@investment_fund.total_invested) %>
    <% end %>

    <%# Explanation:: This card identifies the most recent price per unit to provide
      #               up-to-date valuations; it is used for financial monitoring
      #               and works by fetching the latest quota record from the database.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Cotação Atual",
               card_icon: "chart-line" do
    %>
      <%= normalize_currency(@investment_fund.latest_quota_value) %>
    <% end %>

    <%# Explanation:: This card counts the number of separate allocation records
      #               to track diversification; it is used for reporting and works
      #               by totaling the fund investments linking portfolios together.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Alocações Ativas",
               card_icon: "chart-pie" do
    %>
      <%= normalize_number(@investment_fund.fund_investments.count) %>
    <% end %>
  <% end %>

  <%# Explanation:: This section organizes visual charts to help users understand
    #               trends and distribution; it is used for data analysis and
    #               works by rendering pie and line graphs in a two-column layout.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações",
             columns: 2 do
  %>

    <%# Explanation:: This chart shows how the fund's value is divided among
      #               different owners to visualize concentration; it is used for
      #               risk assessment and works by generating a dynamic donut graph.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @investment_fund.fund_investments.includes(portfolio: :user).map { |fi|
                 ["#{fi.portfolio.name} (#{fi.portfolio.user.full_name})", fi.total_invested_value || 0]
               }.to_h,
               chart_title: "Distribuição por Carteira",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 donut: true,
                 legend: "right"
               } %>

    <%# Explanation:: This chart tracks the fund's price movement over the last
      #               month to show performance; it is used for market analysis
      #               and works by plotting daily quota values on a smooth curve.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: @investment_fund.fund_valuation
                                            .where("date >= ?", 30.days.ago)
                                            .order(date: :asc)
                                            .pluck(:date, :quota_value)
                                            .map { |date, value| [date.strftime("%d/%m"), value] }
                                            .to_h,
               chart_title: "Histórico de Cotação (30 dias)",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true
               } %>
  <% end %>

  <%# Explanation:: This table identifies every portfolio that holds a share of
    #               this fund for detailed tracking; it is used for portfolio
    #               oversight and works by listing owners and their invested amounts.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Carteiras que Investem Neste Fundo",
             collection: @investment_fund.fund_investments.includes(portfolio: :user),
             action_path: nil,
             action_name: nil,
             headers: ["Carteira", "Proprietário", "Alocação", "Valor Investido", "Cotas Detidas"],
             column_icons: ["wallet", "user", "shuffle", "banknote", "percent"],
             body_procs: [
               ->(fi) do
                 normalize_title(fi.portfolio.name)
               end,
               ->(fi) do
                 normalize_text(fi.portfolio.user.full_name)
               end,
               ->(fi) do
                 normalize_percentage(fi.percentage_allocation)
               end,
               ->(fi) do
                 normalize_currency(fi.total_invested_value)
               end,
               ->(fi) do
                 normalize_number(fi.total_quotas_held)
               end,
             ]
  %>

  <%# Explanation:: This container provides a side-by-side view of recent fund
    #               movements to simplify audit tasks; it is used to verify money
    #               flows and works by organizing activity into two visual columns.
    %>
  <%= render "partials/route/dashboard/section",
             columns: 2,
             has_action: false do
  %>

    <%# Explanation:: This list identifies the five most recent money deposits
      #               to highlight growth; it is used to track inflows and works
      #               by fetching the latest application records for this fund.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Aplicações Recentes",
               section_columns: 1,
               collection: Application.joins(:fund_investment)
                                      .where(fund_investments: { investment_fund_id: @investment_fund.id })
                                      .includes(fund_investment: { portfolio: :user })
                                      .order(request_date: :desc)
                                      .limit(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_investment_fund_id_eq: @investment_fund.id }),
               title_proc: ->(app) { app.fund_investment.portfolio.name },
               value_proc: ->(app) { "+ R$#{app.financial_value}" },
               sub_value_proc: ->(app) { "#{app.number_of_quotas} cotas" } %>

    <%# Explanation:: This list identifies the five most recent money withdrawals
      #               to monitor liquidity; it is used to track outflows and
      #               works by displaying redemption records with a danger theme.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Resgates Recentes",
               section_columns: 1,
               collection: Redemption.joins(:fund_investment)
                                     .where(fund_investments: { investment_fund_id: @investment_fund.id })
                                     .includes(fund_investment: { portfolio: :user })
                                     .order(request_date: :desc)
                                     .limit(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_investment_fund_id_eq: @investment_fund.id }),
               title_proc: ->(red) { red.fund_investment.portfolio.name },
               value_proc: ->(red) { "- R$#{red.redeemed_liquid_value}" },
               sub_value_proc: ->(red) { "#{red.redeemed_quotas} cotas" } %>
  <% end %>

  <%# Explanation:: This table summarizes the historical price changes to show
    #               long-term value trends; it is used for performance review and
    #               works by listing the last ten updates with percentage variations.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Histórico de Cotações",
             collection: @investment_fund.fund_valuation.order(date: :desc).limit(10),
             action_path: nil,
             action_name: nil,
             headers: ["Data", "Valor da Cota", "Variação", "Atualizado em"],
             column_icons: ["calendar", "calculator", "trending-up-down", "clock"],
             body_procs: [
               ->(val) do
                 normalize_date(val.date)
               end,
               ->(val) do
                 normalize_currency(val.quota_value)
               end,
               ->(val) do
                 previous_val = @investment_fund.fund_valuation.where("date < ?", val.date).order(date: :desc).first

                 return normalize_no_data unless previous_val&.quota_value

                 change = ((val.quota_value - previous_val.quota_value) / previous_val.quota_value * 100)

                 normalize_trend(change, format: :percentage)
               end,
               ->(val) do
                 normalize_date(val.date)
               end,
             ]
  %>
<% end %>