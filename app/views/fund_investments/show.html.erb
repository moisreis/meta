<%#
  # Partial: show.html.erb
  # Date: 12/24/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays a comprehensive dashboard view for a single FundInvestment record.
  #              Shows investment metrics, performance calculations, transaction history, allocation details,
  #              and historical performance trends with interactive charts.
  #
  # Usage:: - What: Renders the complete show view for the FundInvestment resource with detailed
  #                performance metrics, ROI calculations, transaction breakdowns, and trend analysis.
  #         - How: Accessed via GET /fund_investments/:id. Uses the **@fund_investment** instance variable
  #                loaded by **FundInvestmentsController#show** along with calculated metrics.
  #         - Why: Provides users with a centralized dashboard to monitor a specific fund investment's
  #                performance, track transactions, analyze returns, and understand their position.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure consistency; it is used as the main
  #               container and works by setting the fund name as the title and
  #               the portfolio name as the description.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @fund_investment.investment_fund.fund_name,
           page_desc: "Investimento no portfólio #{@fund_investment.portfolio.name}",
           current_view: "show" do
%>

<%# Explanation:: This section groups primary identifying information for the investment
  #               to provide quick context; it is used to display basic registration
  #               data and works by creating a four-column grid with an edit action button.
  %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visão Geral do Investimento",
             section_desc: "Dados principais e identificação",
             columns: 4,
             has_action: true,
             button_route: edit_fund_investment_path(@fund_investment),
             button_name: "Editar",
             button_icon: "pencil" do
  %>

<%# Explanation:: This card identifies the specific portfolio containing the investment
  #               to clarify asset location; it is used for navigation and works
  #               by rendering a link to the portfolio's main page.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Portfólio",
               card_icon: "briefcase",
               card_data: @fund_investment.portfolio.user.full_name do
    %>
      <%= link_to @fund_investment.portfolio.name, portfolio_path(@fund_investment.portfolio), class: "hover:underline" %>
    <% end %>

<%# Explanation:: This card displays the associated investment fund to show the
  #               nature of the asset; it is used to provide deep-dive access
  #               and works by linking directly to the fund's detail page.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Fundo de Investimento",
               card_icon: "building-2" do
    %>
      <%= link_to @fund_investment.investment_fund.fund_name, investment_fund_path(@fund_investment.investment_fund), class: "hover:underline" %>
    <% end %>

<%# Explanation:: This card shows the percentage weight of this investment within
  #               the portfolio to track strategy; it is used for balance monitoring
  #               and works by rendering the calculated decimal value as a percentage.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Alocação no Portfólio",
               card_icon: "chart-pie",
               status: :secondary do
    %>
      <%= number_with_precision(@fund_investment.percentage_allocation, precision: 2) %>%
    <% end %>

<%# Explanation:: This card displays the record's creation date to track the history
  #               of the investment; it is used for audit purposes and works by
  #               applying a standardized timestamp format to the entry date.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Criado em",
               card_icon: "calendar-plus" do
    %>
      <%= formatted_timestamp(@fund_investment.created_at) %>
    <% end %>
  <% end %>

<%# Explanation:: This section groups live valuation metrics to show the current
  #               financial status of the asset; it is used for position monitoring
  #               and works by comparing invested capital against current market values.
  %>
  <%= render "partials/route/dashboard/section",
             section_title: "Métricas de Posição",
             section_desc: "Valores atuais e saldos",
             columns: 4 do
  %>

<%# Explanation:: This card sums all net capital invested to show the total money
  #               deployed; it is used to calculate the cost basis and works by
  #               displaying the attribute as a standardized currency value.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Valor Total Investido",
               card_icon: "banknote",
               status: :primary do
    %>
      <%= standard_currency(@fund_investment.total_invested_value) %>
    <% end %>

<%# Explanation:: This card displays the quantity of ownership units held to
  #               show position size; it is used for valuation math and works
  #               by rendering the total quota count with two decimal points.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Cotas Detidas",
               card_icon: "scale" do
    %>
      <%= number_with_precision(@fund_investment.total_quotas_held, precision: 2) %>
    <% end %>

<%# Explanation:: This card shows what the investment is worth at today's prices
  #               to visualize net worth; it is used for financial assessment
  #               and works by applying conditional colors based on profit or loss.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Valor de Mercado Atual",
               card_icon: "trending-up",
               card_data: @fund_investment.investment_fund.latest_quota_value ?
                            standard_currency(@fund_investment.investment_fund.latest_quota_value) :
                            "N/A",
               status: (
                 if @fund_investment.current_market_value > @fund_investment.total_invested_value
                   :success
                 elsif @fund_investment.current_market_value < @fund_investment.total_invested_value
                   :danger
                 else
                   :default
                 end
               ) do
    %>
      <%= standard_currency(@fund_investment.current_market_value) %>
    <% end %>

<%# Explanation:: This card highlights the difference between invested and current
  #               value to show financial performance; it is used for ROI tracking
  #               and works by displaying gain or loss with dynamic arrow icons.
  %>
    <%
      gain_loss = @fund_investment.unrealized_gain_loss
      is_positive = gain_loss > 0
      is_negative = gain_loss < 0
    %>
    <%= render "partials/route/dashboard/card",
               card_title: "Ganhos e Perdas",
               card_icon: is_positive ? "arrow-up" : (is_negative ? "arrow-down" : "minus"),
               card_data: "#{is_positive ? '+' : ''}#{number_with_precision(@fund_investment.return_percentage, precision: 2)}%",
               status: (is_positive ? :success : (is_negative ? :danger : :default)) do
    %>
      <%= is_positive ? '+' : '' %><%= standard_currency(gain_loss.abs) %>
    <% end %>
  <% end %>

<%# Explanation:: This section summarizes transaction flows to analyze the
  #               investment's profitability; it is used for historical performance
  #               review and works by aggregating applications and redemptions.
  %>
  <%= render "partials/route/dashboard/section",
             section_title: "Performance e Retorno",
             section_desc: "Análise de rentabilidade do investimento",
             columns: 4 do
  %>

<%# Explanation:: This card displays the total gross money applied to the fund
  #               to show historical effort; it is used to track capital inflow
  #               and works by rendering the sum of all application records.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Total de Aplicações",
               card_icon: "banknote" do
    %>
      <%= standard_currency(@fund_investment.total_applications) %>
    <% end %>

<%# Explanation:: This card displays the total money withdrawn from the fund
  #               to show capital exit; it is used to track outflows and works
  #               by rendering the sum of all redemption records in red.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Total de Resgates",
               card_icon: "arrow-down-left" do
    %>
      <%= standard_currency(@fund_investment.total_redemptions) %>
    <% end %>

<%# Explanation:: This card identifies the net capital remaining after all
  #               transactions to show current investment; it is used for flow
  #               analysis and works by subtracting redemptions from applications.
  %>
    <%= render "partials/route/dashboard/card",
               card_title: "Fluxo Líquido",
               card_icon: "repeat" do
    %>
      <%= standard_currency(@fund_investment.total_applications - @fund_investment.total_redemptions) %>
    <% end %>

<%# Explanation:: This card calculates the percentage return on the capital
  #               employed to show efficiency; it is used for ranking assets
  #               and works by comparing net gains against the invested principal.
  %>
    <%
      roi = @fund_investment.return_percentage
      roi_positive = roi > 0
      roi_negative = roi < 0
    %>
    <%= render "partials/route/dashboard/card",
               card_title: "Retorno sobre Investimento",
               card_icon: roi_positive ? "smile" : (roi_negative ? "frown" : "minus"),
               card_data: roi_positive ? "Lucro" : (roi_negative ? "Prejuízo" : "Neutro"),
               card_data_icon: roi_positive ? "trending-up" : (roi_negative ? "trending-down" : "minus"),
               status: roi_positive ? :success : (roi_negative ? :danger : :default) do
    %>
      <%= roi_positive ? '+' : '' %><%= number_with_precision(roi, precision: 2) %>%
    <% end %>
  <% end %>

<%# Explanation:: This section organizes visual graphs to provide a better
  #               understanding of movement trends; it is used for data analysis
  #               and works by rendering distribution and flow charts side-by-side.
  %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações de Performance",
             columns: 2 do
  %>

<%# Explanation:: This chart shows the balance between money added and money
  #               taken out to visualize activity; it is used for flow review
  #               and works by rendering a dynamic donut graph with currency labels.
  %>
    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: {
                 "Aplicações" => @fund_investment.total_applications,
                 "Resgates" => @fund_investment.total_redemptions
               },
               chart_title: "Distribuição de Transações",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 donut: true,
                 legend: "right"
               } %>

    <%# Explanation:: This chart tracks the monthly flow of transactions to reveal
      #               investing patterns over time; it is used for historical analysis
      #               and works by plotting application and redemption values on a timeline.
      %>
    <%
      monthly_data = {}

      @fund_investment.applications.each do |app|
        month_key = app.request_date.strftime("%m/%Y")
        monthly_data[month_key] ||= { "Aplicações" => 0, "Resgates" => 0 }
        monthly_data[month_key]["Aplicações"] += app.financial_value || 0
      end

      @fund_investment.redemptions.each do |red|
        month_key = red.request_date.strftime("%m/%Y")
        monthly_data[month_key] ||= { "Aplicações" => 0, "Resgates" => 0 }
        monthly_data[month_key]["Resgates"] += red.redeemed_liquid_value || 0
      end

      monthly_flows = monthly_data.sort_by { |k, v| Date.strptime(k, "%m/%Y") }.to_h
    %>
    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: monthly_flows,
               chart_title: "Fluxo Mensal de Transações",
               chart_options: {
                 stacked: false,
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true
               } %>
  <% end %>

<%# Explanation:: This table lists all money deposits made into this specific
  #               investment for record keeping; it is used to audit applications
  #               and works by showing dates, values, and unit prices for each entry.
  %>
  <%= render "partials/groups/table-list",
             section_title: "Histórico de Aplicações",
             collection: @fund_investment.applications.order(request_date: :desc),
             action_path: new_application_path(fund_investment_id: @fund_investment.id),
             action_name: "Nova aplicação",
             headers: ["Solicitação", "Valor Financeiro", "Cotas Adquiridas", "Cotação na Aplicação", "Cotização", "Liquidação"],
             column_icons: [
               "calendar-plus",
               "banknote",
               "percent",
               "calculator",
               "calendar-setting",
               "calendar-check-2"
             ],
             body_procs: [
               ->(app) { formatted_timestamp(app.request_date) },
               ->(app) { colored_currency(app.financial_value) },
               ->(app) { colored_numerical(app.number_of_quotas) },
               ->(app) { app.quota_value_at_application ? standard_currency(app.quota_value_at_application) : "N/A" },
               ->(app) { app.cotization_date ? formatted_timestamp(app.cotization_date) : "N/A" },
               ->(app) { app.liquidation_date ? formatted_timestamp(app.liquidation_date) : "N/A" }
             ]
  %>

<%# Explanation:: This table lists all money withdrawals made from this investment
  #               for financial tracking; it is used to monitor redemptions and
  #               works by showing liquidated values and calculated yields for each exit.
  %>
  <%= render "partials/groups/table-list",
             section_title: "Histórico de Resgates",
             collection: @fund_investment.redemptions.order(request_date: :desc),
             action_path: new_redemption_path(fund_investment_id: @fund_investment.id),
             action_name: "Novo resgate",
             headers: ["Solicitação", "Cotas Resgatadas", "Valor Líquido", "Tipo de Resgate", "Rendimento", "Cotização", "Liquidação"],
             column_icons: [
               "calendar-plus",
               "arrow-down-to-line",
               "coins",
               "tag",
               "trending-up-down",
               "calculator",
               "calendar-check-2"
             ],
             body_procs: [
               ->(red) { formatted_timestamp(red.request_date) },
               ->(red) { colored_numerical(red.redeemed_quotas) },
               ->(red) { colored_currency(red.redeemed_liquid_value) },
               ->(red) { content_tag(:span, red.redemption_type || "N/A", class: "badge badge-secondary") },
               ->(red) { red.redemption_yield ? standard_currency(red.redemption_yield) : "N/A" },
               ->(red) { red.cotization_date ? formatted_timestamp(red.cotization_date) : "N/A" },
               ->(red) { red.liquidation_date ? formatted_timestamp(red.liquidation_date) : "N/A" }
             ]
  %>

<%# Explanation:: This section provides a quick summary of the very latest
  #               movements to show current activity; it is used for fast review
  #               and works by displaying the five most recent transactions of each type.
  %>
  <%= render "partials/route/dashboard/section",
             columns: 2,
             has_action: false do
  %>

<%# Explanation:: This list highlights the five newest deposits to track recent
  #               growth; it is used for immediate visibility and works by
  #               showing the added amounts with a success-themed color.
  %>
    <%= render "partials/groups/recent_activity",
               section_title: "Últimas 5 Aplicações",
               section_columns: 1,
               collection: @fund_investment.applications.order(request_date: :desc).limit(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_id_eq: @fund_investment.id }),
               title_proc: ->(app) { "Aplicação" },
               value_proc: ->(app) { "+ R$#{app.financial_value}" },
               sub_value_proc: ->(app) { "#{app.number_of_quotas} cotas" } %>

<%# Explanation:: This list highlights the five newest withdrawals to monitor
  #               recent liquidity; it is used for immediate visibility and works
  #               by showing the taken amounts with a danger-themed color.
  %>
    <%= render "partials/groups/recent_activity",
               section_title: "Últimos 5 Resgates",
               section_columns: 1,
               collection: @fund_investment.redemptions.order(request_date: :desc).limit(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_id_eq: @fund_investment.id }),
               title_proc: ->(red) { "Resgate #{red.redemption_type || 'Padrão'}" },
               value_proc: ->(red) { "- R$#{red.redeemed_liquid_value}" },
               sub_value_proc: ->(red) { "#{red.redeemed_quotas} cotas" } %>
  <% end %>

<%# Explanation:: This table displays periodic snapshots of performance to
  #               show long-term growth; it is used for strategic review and
  #               works by listing market vs. invested values over time.
  %>
  <%= render "partials/groups/table-list",
             section_title: "Histórico de Performance",
             collection: @fund_investment.performance_histories.order(created_at: :desc).limit(10),
             action_path: nil,
             action_name: nil,
             headers: ["Data do Registro", "Valor de Mercado", "Valor Investido", "Ganho/Perda", "Retorno"],
             column_icons: [
               "calendar",
               "trending-up",
               "banknote",
               "trending-up-down",
               "percent"
             ],
             body_procs: [
               ->(perf) { formatted_timestamp(perf.created_at) },
               ->(perf) { colored_currency(perf.market_value, "h-auto") },
               ->(perf) { colored_currency(perf.invested_value, "h-auto") },
               ->(perf) { colored_currency(perf.market_value - perf.invested_value, "h-auto") },
               ->(perf) do
                 return_pct = perf.invested_value > 0 ? ((perf.market_value - perf.invested_value) / perf.invested_value * 100) : 0
                 colored_percentage(return_pct, "h-auto")
               end
             ]
  %>
<% end %>