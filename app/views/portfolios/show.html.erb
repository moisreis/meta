<%#
  # Partial: show.html.erb
  # Date: 12/3/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays the detailed dashboard view for a single investment portfolio.
  #              It consolidates summary statistics, performance charts, a list of
  #              allocated funds, recent transaction history, and sharing permissions.
  #
  # Usage: - What: Renders the comprehensive detail page for a specific user's investment portfolio.
  #                It allows the owner to monitor and manage their allocated funds and performance.
  #        - How: This partial is rendered from the **PortfoliosController#show** action, receiving
  #               the **@portfolio** instance variable.
  #        - Why: Provides a single, centralized view for performance tracking, auditing allocations,
  #               and initiating new investment or redemption transactions.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure. It sets the main title and owner description
  #               so the user always knows which portfolio is being viewed.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @portfolio.name,
           page_desc: "Carteira de #{@portfolio.user.full_name}",
           current_view: "show" do
%>

  <%# Explanation:: This section groups high-level summary cards into a single row.
    #               It provides an immediate financial overview, helping the user
    #               understand the portfolio's health at a quick glance.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Resumo",
             section_desc: "Exibe os dados gerais da carteira",
             columns: 4,
             has_action: true,
             button_route: "",
             button_name: "Editar",
             button_icon: "pencil" do
  %>

    <%# Explanation:: This card displays the total capital currently held in the portfolio.
      #               It uses currency formatting and a trend icon to show how the
      #               invested amount has changed over the recent period.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Valor Total Investido",
               card_icon: "banknote",
               card_data: "+ 56%",
               card_data_icon: "trending-up",
               status: :primary do
    %>
      <%= standard_currency(@portfolio.total_invested_value) %>
    <% end %>

    <%# Explanation:: This card tracks the total number of fund units owned by the user.
      #               It monitors the volume of shares held across all investments
      #               to help the owner see the physical scale of their assets.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Cotas Totais",
               card_icon: "scale",
               card_data: "- 51%",
               card_data_icon: "trending-down",
               status: :secondary do
    %>
      <%= @portfolio.total_quotas_held %>
    <% end %>

    <%# Explanation:: This card counts how many different investment funds are active.
      #               It helps the user visualize their diversification strategy by
      #               showing the variety of financial products currently in use.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Número de Fundos",
               card_icon: "coins",
               card_data: "+ 56%",
               card_data_icon: "trending-up",
               is_success: true do
    %>
      <%= @portfolio.fund_investments.count %>
    <% end %>

    <%# Explanation:: This card verifies if the fund percentages are mathematically correct.
      #               It checks that the allocation reaches the required total, ensuring
      #               the portfolio is balanced and ready for financial reporting.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Alocação Válida",
               card_icon: "list-plus",
               card_data: "Total de #{number_with_precision(@portfolio.fund_investments.sum(:percentage_allocation), precision: 0)}%",
               card_data_icon: "trending-up-down",
               status: (@portfolio.valid_allocations? ? :success : :danger) do
    %>
      <% if @portfolio.valid_allocations? %>
        <%= content_tag :span, "Válida" %>
      <% else %>
        <%= content_tag :span, "Inválida" %>
      <% end %>
    <% end %>
  <% end %>

  <%# Explanation:: This section organizes complex data into visual charts and graphs.
    #               It splits the view to allow the user to compare asset distribution
    #               against historical transaction trends in a single view.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações",
             is_two_col: true do
  %>

    <%# Explanation:: This block displays a circular chart showing how funds are divided;
      #               it is used to visualize percentages and works by passing specific
      #               settings like a donut shape and a side legend to the chart helper.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @allocation_data,
               chart_title: "Fundos alocados",
               chart_options: {
                 suffix: "%",
                 donut: true,
                 legend: "right"
               } %>

    <%# Explanation:: This block renders a line graph to track transaction trends over time;
      #               it is used to show growth or movement and works by formatting values
      #               with local currency symbols and smoothing the visual curves.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: @monthly_flows,
               chart_title: "Transações",
               chart_options: {
                 stacked: true,
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true,
               } %>
  <% end %>

  <%# Explanation:: This table lists every fund investment with precise numerical data.
    #               It uses specialized formatting to show percentages, currency, and
    #               quota counts in a clear, row-by-row structure for deep auditing.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Lista de fundos alocados",
             collection: @portfolio.fund_investments.includes(:investment_fund),
             action_path: new_fund_investment_path(portfolio_id: @portfolio.id),
             action_name: "Nova alocação",
             headers: ["Fundo", "Alocação", "Valor Investido", "Cotas"],
             column_icons: ["layers", "shuffle", "banknote", "percent"],
             body_procs: [
               ->(fi) { content_tag(:span, fi.investment_fund.fund_name) },
               ->(fi) { colored_percentage(fi.percentage_allocation) },
               ->(fi) { colored_currency(fi.total_invested_value) },
               ->(fi) { colored_numerical(fi.total_quotas_held) }
             ]
  %>

  <%# Explanation:: This container sets up a side-by-side view for recent movement logs.
    #               It ensures that new applications and redemptions are displayed
    #               together so the user can verify their most recent actions easily.
    %>
  <%= render "partials/route/dashboard/section",
             columns: 2,
             has_action: false do
  %>

    <%# Explanation:: This list shows the five most recent deposits made into funds.
      #               It uses a success theme to highlight positive growth and
      #               provides quick links to see the full application history.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Aplicações Recentes",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:applications).flat_map(&:applications).sort_by(&:request_date).reverse.first(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(app) { app.fund_investment.investment_fund.fund_name },
               value_proc: ->(app) { "+ R$#{app.financial_value}" },
               sub_value_proc: ->(app) { "#{app.number_of_quotas} cotas" } %>

    <%# Explanation:: This list displays the five most recent withdrawals from the funds.
      #               It applies a danger theme to separate redemptions from deposits,
      #               helping the user track their liquidity and cash outflows.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Resgates Recentes",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:redemptions).flat_map(&:redemptions).sort_by(&:request_date).reverse.first(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(red) { red.fund_investment.investment_fund.fund_name },
               value_proc: ->(red) { "- R$#{red.redeemed_liquid_value}" },
               sub_value_proc: ->(red) { "#{red.redeemed_quotas} cotas" } %>

  <% end %>

  <%# Explanation:: This block lists users who have shared access to this portfolio.
    #               It shows their names and specific permission levels so the owner
    #               always knows who can view or modify their financial data.
    %>
  <%= render "partials/groups/recent_activity",
             section_title: "Compartilhamento",
             collection: @portfolio.user_portfolio_permissions.includes(:user),
             color: "secondary",
             see_all_path: "#",
             title_proc: ->(perm) { perm.user.full_name },
             value_proc: ->(perm) { perm.permission_level },
             sub_value_proc: ->(perm) { perm.user.email } %>
<% end %>