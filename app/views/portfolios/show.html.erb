<%#
  # Partial: show.html.erb
  # Date: 12/3/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays the detailed dashboard view for a single investment portfolio.
  #              It consolidates summary statistics, performance charts, a list of
  #              allocated funds, recent transaction history, and sharing permissions.
  #
  # Usage: - What: Renders the comprehensive detail page for a specific user's investment portfolio.
  #                It allows the owner to monitor and manage their allocated funds and performance.
  #        - How: This partial is rendered from the **PortfoliosController#show** action, receiving
  #               the **@portfolio** instance variable.
  #        - Why: Provides a single, centralized view for performance tracking, auditing allocations,
  #               and initiating new investment or redemption transactions.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure. It sets the main title and owner description
  #               so the user always knows which portfolio is being viewed.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @portfolio.name,
           page_desc: "Carteira de #{@portfolio.user.full_name}",
           current_view: "show" do
%>

  <%= render "partials/groups/card-group",
             theme: :dark,
             items: [
               {
                 title: "Minha carteira",
                 value: standard_currency(@portfolio.total_invested_value),
                 theme: :primary
               },
               {
                 title: "Retorno de investimento",
                 value: standard_currency(@total_earnings),
                 theme: :default
               },
               {
                 title: "Cotas",
                 value: @portfolio.total_quotas_held,
                 theme: :default
               },
               {
                 title: "Rentabilidade",
                 value: "#{@portfolio_return.round(2)}%",
                 theme: :default
               }
             ] %>


    <%# Explanation:: This section organizes complex data into visual charts and graphs.
    #               It splits the view to allow the user to compare asset distribution
    #               against historical transaction trends in a single view.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações",
             columns: 2 do
  %>

    <%# Explanation:: This block displays a circular chart showing how funds are divided;
      #               it is used to visualize percentages and works by passing specific
      #               settings like a donut shape and a side legend to the chart helper.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @allocation_data,
               chart_title: "Fundos alocados",
               chart_options: {
                 suffix: "%",
                 donut: true,
                 legend: "right"
               } %>

    <%# Explanation:: This block renders a line graph to track transaction trends over time;
      #               it is used to show growth or movement and works by formatting values
      #               with local currency symbols and smoothing the visual curves.
      %>
    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: @monthly_flows,
               chart_title: "Transações",
               chart_options: {
                 stacked: true,
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true,
               } %>
  <% end %>

  <%# Explanation:: This table lists every fund investment with precise numerical data.
    #               It uses specialized formatting to show percentages, currency, and
    #               quota counts in a clear, row-by-row structure for deep auditing.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Lista de fundos alocados",
             collection: @portfolio.fund_investments.includes(:investment_fund),
             action_path: new_fund_investment_path(portfolio_id: @portfolio.id),
             action_name: "Nova alocação",
             headers: ["Fundo", "Alocação", "Valor Investido", "Cotas"],
             column_icons: ["layers", "shuffle", "banknote", "percent"],
             body_procs: [
               ->(fi) { content_tag(:span, fi.investment_fund.fund_name) },
               ->(fi) { colored_percentage(fi.percentage_allocation) },
               ->(fi) { colored_currency(fi.total_invested_value) },
               ->(fi) { colored_numerical(fi.total_quotas_held) }
             ]
  %>

  <%# ================================================================ %>
<%# SEÇÃO DE PERFORMANCE                                            %>
<%# ================================================================ %>

<%# Card de Rentabilidade Total da Carteira %>
  <% if @recent_performance.any? %>
    <%= render(
          "partials/route/dashboard/section",
          section_title: "Rentabilidade da Carteira",
          section_desc: "Performance do período de #{@reference_period.strftime('%B/%Y')}",
          columns: 3,
          has_action: false
        ) do %>

      <%# Rendimento Total (R$) %>
      <%= render(
            "partials/route/dashboard/card",
            card_title: "Rendimento Total",
            card_icon: "wallet",
            card_data: "#{@portfolio_return.round(2)}%",
            card_data_icon: "trending-up",
            status: (@total_earnings > 0 ? :success : :danger)
          ) do %>
        <%= standard_currency(@total_earnings) %>
      <% end %>

      <%# Rentabilidade da Carteira (%) %>
      <%= render(
            "partials/route/dashboard/card",
            card_title: "Rentabilidade Carteira",
            card_icon: "percent",
            card_data: "Período: #{@reference_period.strftime('%m/%Y')}",
            status: :primary
          ) do %>
        <%= "#{@portfolio_return.round(2)}%" %>
      <% end %>

      <%# Valor da Carteira %>
      <%= render(
            "partials/route/dashboard/card",
            card_title: "Valor da Carteira",
            card_icon: "banknote",
            card_data: "Base para cálculo",
            status: :secondary
          ) do %>
        <%= standard_currency(@portfolio.total_invested_value) %>
      <% end %>

    <% end %>

    <%# Tabela de Performance por Fundo %>
    <%= render(
          "partials/groups/table-list",
          section_title: "Performance dos Fundos",
          collection: @recent_performance,
          action_path: "#",
          action_name: "Ver histórico",
          headers: ["Fundo", "Rentabilidade", "Rendimento"],
          column_icons: ["trending-up", "percent", "banknote"],
          body_procs: [
            ->(ph) {
              content_tag(
                :span,
                ph.fund_investment.investment_fund.fund_name,
                class: "font-medium"
              )
            },
            ->(ph) { colored_percentage(ph.monthly_return) },
            ->(ph) { colored_currency(ph.earnings) }
          ]
        ) %>

  <% else %>
    <%# Mensagem quando não há dados de performance %>
    <%= render(
          "partials/route/dashboard/section",
          section_title: "Rentabilidade da Carteira",
          section_desc: "Aguardando dados de performance",
          has_action: false
        ) do %>

      <p>Nenhum dado de performance disponível para esta carteira.</p>

      <p>
        Execute o job de cálculo de performance para gerar os dados:
        <code>rails performance:calculate</code>
      </p>

    <% end %>
  <% end %>


  <%# Explanation:: This container sets up a side-by-side view for recent movement logs.
    #               It ensures that new applications and redemptions are displayed
    #               together so the user can verify their most recent actions easily.
    %>
  <%= render "partials/route/dashboard/section",
             columns: 2,
             has_action: false do
  %>

    <%# Explanation:: This list shows the five most recent deposits made into funds.
      #               It uses a success theme to highlight positive growth and
      #               provides quick links to see the full application history.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Aplicações Recentes",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:applications).flat_map(&:applications).sort_by(&:request_date).reverse.first(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(app) { app.fund_investment.investment_fund.fund_name },
               value_proc: ->(app) { "+ R$#{app.financial_value}" },
               sub_value_proc: ->(app) { "#{app.number_of_quotas} cotas" } %>

    <%# Explanation:: This list displays the five most recent withdrawals from the funds.
      #               It applies a danger theme to separate redemptions from deposits,
      #               helping the user track their liquidity and cash outflows.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Resgates Recentes",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:redemptions).flat_map(&:redemptions).sort_by(&:request_date).reverse.first(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(red) { red.fund_investment.investment_fund.fund_name },
               value_proc: ->(red) { "- R$#{red.redeemed_liquid_value}" },
               sub_value_proc: ->(red) { "#{red.redeemed_quotas} cotas" } %>

  <% end %>

  <%# Explanation:: This block lists users who have shared access to this portfolio.
    #               It shows their names and specific permission levels so the owner
    #               always knows who can view or modify their financial data.
    %>
  <%= render "partials/groups/recent_activity",
             section_title: "Compartilhamento",
             collection: @portfolio.user_portfolio_permissions.includes(:user),
             color: "secondary",
             see_all_path: "#",
             title_proc: ->(perm) { perm.user.full_name },
             value_proc: ->(perm) { perm.permission_level },
             sub_value_proc: ->(perm) { perm.user.email } %>
<% end %>