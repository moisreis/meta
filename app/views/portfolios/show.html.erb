<%#
  # Partial: show.html.erb
  # Date: 12/3/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays the detailed dashboard view for a single investment portfolio.
  #              It consolidates summary statistics, performance charts, a list of
  #              allocated funds, recent transaction history, and sharing permissions.
  #
  # Usage: - What: Renders the comprehensive detail page for a specific user's investment portfolio.
  #                It allows the owner to monitor and manage their allocated funds and performance.
  #        - How: This partial is rendered from the **PortfoliosController#show** action, receiving
  #               the **@portfolio** instance variable.
  #        - Why: Provides a single, centralized view for performance tracking, auditing allocations,
  #               and initiating new investment or redemption transactions.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure. It sets the main title and owner description
  #               so the user always knows which portfolio is being viewed.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @portfolio.name,
           page_desc: "Carteira de #{@portfolio.user.full_name}",
           current_view: "show" do
%>

  <%= render "partials/route/dashboard/section",
             section_title: "Período de Referência",
             columns: 1 do
  %>
    <%= form_with url: portfolio_path(@portfolio), method: :get, local: true do |f| %>
      <%= render "partials/modules/select",
                 f: f,
                 name: :reference_date,
                 label: "Data de referência",
                 desc: "Selecione a data para visualizar os valores da carteira.",
                 is_half_width: true,
                 options_collection: @portfolio.performance_histories
                                               .order(period: :desc)
                                               .pluck(:period)
                                               .map { |d| [l(d, format: :long), d] },
                 is_inactive: false
      %>
      <%= f.submit "Aplicar", class: "button button-small button-secondary w-fit" %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "KPIs",
             columns: 4 do
  %>
    <%= render(
          "partials/route/dashboard/card",
          card_title: "Retorno de investimento",
          card_icon: "wallet",
          card_data: normalize_card_percentage(@portfolio.portfolio_return_percentage),
          card_data_icon: card_data_icon_for(@portfolio.total_gain),
          status: card_status_trend_for(@portfolio.total_gain)
        ) do
    %>
      <%= normalize_currency(@portfolio.total_gain) %>
    <% end %>

    <%= render(
          "partials/route/dashboard/card",
          card_title: "Total da Carteira",
          card_icon: "banknote",
          ) do
    %>
      <%= normalize_currency(@portfolio.total_current_market_value) %>
    <% end %>

    <%= render(
          "partials/route/dashboard/card",
          card_title: "Rentabilidade do Ano",
          card_icon: "calendar",
          card_data: normalize_card_text("Ano Atual"),
          status: card_status_trend_for(@portfolio_yearly_return)
        ) do
    %>
      <%= normalize_percentage(@portfolio_yearly_return) %>
    <% end %>

    <%= render(
          "partials/route/dashboard/card",
          card_title: "Últimos 12 meses",
          card_icon: "trending-up",
          card_data: normalize_card_time_ago(@reference_period),
          status: card_status_trend_for(@portfolio_12m_return)
        ) do
    %>
      <%= normalize_percentage(@portfolio_12m_return) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Análise Detalhada",
             columns: 2 do
  %>

    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: @monthly_earnings_history,
               chart_title: "Rendimento Mensal",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :area_chart,
               data_source: @equity_evolution,
               chart_title: "Evolução do Patrimônio",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 points: true,
                 dataset: { borderWidth: 0 },
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :column_chart,
               data_source: @monthly_flows,
               chart_title: "Movimentações",
               chart_options: {
                 stacked: false,
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 dataset: { borderWidth: 0 }
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @institution_distribution,
               chart_title: "Distribuição por Instituição",
               chart_options: {
                 donut: true,
                 legend: "bottom",
                 suffix: "%"
               }
    %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações",
             columns: 2 do
  %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @allocation_data,
               chart_title: "Fundos alocados",
               chart_options: {
                 suffix: "%",
                 donut: true,
                 legend: "right"
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :line_chart,
               data_source: @monthly_flows,
               chart_title: "Transações",
               chart_options: {
                 stacked: true,
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 curve: true,
               }
    %>
  <% end %>

  <%= render "partials/groups/table-list",
             section_title: "Lista de fundos alocados",
             collection: @portfolio.fund_investments.includes(:investment_fund),
             action_path: new_fund_investment_path(portfolio_id: @portfolio.id),
             action_name: "Nova alocação",
             headers: ["Fundo", "Alocação", "Aplicações", "Resgates", "Movimentação", "Cota mais recente", "Valor Final", "Rendimento", "Rent."],
             column_icons: ["layers", "shuffle", "banknote", "percent", "banknote"],
             body_procs: [
               ->(fi) do
                 normalize_title(fi.investment_fund.fund_name)
               end,
               ->(fi) do
                 normalize_percentage(fi.percentage_allocation)
               end,
               ->(fi) do
                 normalize_currency(fi.total_applications)
               end,
               ->(fi) do
                 normalize_currency(fi.total_redemptions)
               end,
               ->(fi) do
                 normalize_trend(fi.net_movement)
               end,
               ->(fi) do
                 normalize_currency(fi.investment_fund.latest_quota_value)
               end,
               ->(fi) do
                 normalize_currency(fi.current_market_value)
               end,
               ->(fi) do
                 normalize_currency(fi.total_gain)
               end,
               ->(fi) do
                 normalize_percentage(fi.period_return_percentage)
               end
             ]
  %>

  <% if @recent_performance.any? %>

    <%= render(
          "partials/groups/table-list",
          section_title: "Performance dos Fundos",
          collection: @recent_performance,
          action_path: "#",
          action_name: "Ver histórico",
          headers: ["Fundo", "Rentabilidade", "Rendimento"],
          column_icons: ["trending-up", "percent", "banknote"],
          body_procs: [
            ->(ph) do
              normalize_title(ph.fund_investment.investment_fund.fund_name)
            end,
            ->(ph) do
              normalize_trend(ph.monthly_return, format: :percentage)
            end,
            ->(ph) do
              normalize_currency(ph.earnings)
            end,
          ]
        ) %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             columns: 2,
             section_title: "APR",
             section_desc: "Autorização de Aplicação e Resgate",
             has_action: false do
  %>

    <%= render "partials/groups/recent_activity",
               section_title: "Aplicações",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:applications).flat_map(&:applications).sort_by(&:request_date).reverse.first(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(app) { app.fund_investment.investment_fund.fund_name },
               value_proc: ->(app) { normalize_currency(app.financial_value) },
               sub_value_proc: ->(app) { "#{app.number_of_quotas} cotas" } %>

    <%# Explanation:: This list displays the five most recent withdrawals from the funds.
      #               It applies a danger theme to separate redemptions from deposits,
      #               helping the user track their liquidity and cash outflows.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Resgates",
               section_columns: 1,
               collection: @portfolio.fund_investments.includes(:redemptions).flat_map(&:redemptions).sort_by(&:request_date).reverse.first(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_portfolio_id_eq: @portfolio.id }),
               title_proc: ->(red) { red.fund_investment.investment_fund.fund_name },
               value_proc: ->(red) { normalize_currency(red.redeemed_liquid_value) },
               sub_value_proc: ->(red) { "#{red.redeemed_quotas} cotas" } %>

  <% end %>
<% end %>