<%#
  # Partial: index.html.erb
  # Date: 11/20/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Constructs the main index page for Portfolio resources. It renders a
  #              dynamic data table to display the list of portfolios and includes
  #              integrated search and filtering components for efficient data querying.
  #
  # Usage: - What: Renders the complete, dynamic index view for the Portfolio resource,
  #                including a fully functional, filterable, and Turbo-integrated data table.
  #        - How: Renders the `_wrapper` for the page layout, followed by the
  #               `_data-table` partial to display the `@portfolios` collection and
  #               the `_filters` partial to handle searching via Ransack (`@q`).
  #               All components are linked via the `portfolios_table` Turbo Frame ID.
  #        - Why: Provides an efficient and interactive interface for users to browse
  #               and manage the Portfolio list while promoting UI consistency through
  #               the use of shared dashboard partials.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure consistency; it is used as the main
  #               container and works by setting the page title and descriptive labels.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: "Lista de carteiras",
           page_desc: "Lista de carteiras com permissão de visualização.",
           current_view: "datatable" do
%>

  <%# Explanation:: This partial generates a dynamic table to list portfolio records
    #               clearly; it is used to present organized data to the user and
    #               works by receiving headers and data-fetching logic as arguments.
    %>
  <%= render partial: "partials/blocks/data-table", locals: {

    # Explanation:: This array defines the text labels displayed at the top of
    #               the table columns; it is used to give context to the data
    #               and works by mapping each string to a specific column header.
    columns_header: [
      "Nome",
      "Proprietário",
      "Valor investido",
      "Cotas"
    ],

    # Explanation:: This collection holds visual icons to accompany the column
    #               titles for better recognition; it is used to beautify the
    #               header and works by rendering specific Material Symbols.
    columns_icons: [
      "tag",
      "user",
      "wallet",
      "percent"
    ],

    # Explanation:: This list contains the logic for filling each row with
    #               portfolio information; it is used to handle data extraction
    #               and works by executing symbols or functions for every record.
    columns_body: [
      ->(portfolio) do
        normalize_title(portfolio.name)
      end,

      # Explanation:: This function identifies and labels the creator of the
      #               portfolio to clarify ownership; it is used in the second
      #               column and works by comparing the owner to the current user.
      # Explanation:: This function identifies and labels the creator of the
      #               portfolio to clarify ownership; it is used in the second
      #               column and works by comparing the owner to the current user.
      ->(portfolio) do
        normalize_badge(portfolio.user&.full_name)
      end,

      # Explanation:: This instruction calculates and formats the total money
      #               held in the portfolio; it is used to show financial
      #               status and works by converting raw numbers into currency text.
      ->(portfolio) do
        normalize_currency(portfolio.total_invested_value)
      end,

      # Explanation:: This line displays the quantity of ownership units held
      #               by the user; it is used to show investment scale and
      #               works by applying numerical formatting to the quota count.
      ->(portfolio) do
        normalize_number(portfolio.total_quotas_held)
      end
    ],

    # Explanation:: This attribute provides the actual list of portfolio objects
    #               retrieved from the database; it is used as the table's
    #               data source and works by feeding the rows into the display loop.
    models: @portfolios,

    # Explanation:: This configuration sets the rules for how users can reorder
    #               the list; it is used to allow custom sorting and works by
    #               integrating with the database search parameters.
    sort_options: [],

    # Explanation:: This object manages the current search and sort criteria
    #               for the collection; it is used to keep track of user
    #               filters and works by generating valid database queries.
    q_object: @q,

    # Explanation:: This path tells the table where to send search and page
    #               requests; it is used to keep the user on the correct page
    #               and works by linking actions to the Portfolio index route.
    search_url: portfolios_path,

    # Explanation:: This unique identifier allows the table to update without
    #               refreshing the whole page; it is used for speed and works
    #               by isolating the table content within a Turbo Frame.
    turbo_frame_id: "portfolios_table",

    # Explanation:: This setting provides a link for users to download the
    #               table data as a file; it is used for reporting and works
    #               by enabling an export button when a URL is provided.
    # FIX: Convertendo params[:q] para hash para evitar erro de unpermitted parameters
    export_url: export_portfolios_path(request.query_parameters.slice('q'))  }
  %>
<% end %>

<%# Explanation:: This partial renders a sidebar or header with search inputs
  #               to help users find data; it is used to refine the list and
  #               works by sending form data to the table's Turbo Frame.
  %>
<%= render partial: "partials/route/dashboard/filters",
           locals: {

             # Explanation:: This search object connects the filter fields to the
             #               database query logic; it is used to pre-fill inputs and
             #               works by syncing with the Ransack gem settings.
             q_object: @q,

             # Explanation:: This destination URL determines where the search filters
             #               are sent upon submission; it is used to refresh the data
             #               and works by targeting the main portfolio list route.
             search_url: portfolios_path,

             # Explanation:: This list defines the specific text and icon for each
             #               filter input box; it is used to build the search form
             #               and works by generating fields for names and users.
             filters: [
               {
                 key: :name_cont,
                 label: "Nome",
                 description: "Mostra carteiras cujo nome contém estes caracteres.",
                 placeholder: "Nome da carteira",
                 icon_name: "wallet"
               },
               {
                 key: :user_first_name_cont,
                 label: "Usuário",
                 description: "Mostra carteiras pertencentes a um usuário cujo nome corresponde a este filtro.",
                 placeholder: "Nome do responsável",
                 icon_name: "user"
               }
             ],

             # Explanation:: This ID links the filter results directly to the table
             #               container for seamless updates; it is used to avoid full
             #               page reloads and works by targeting the specific Turbo Frame.
             turbo_frame_id: "portfolios_table"
           }
%>
