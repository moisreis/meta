<%#
  # Partial: show.html.erb
  # Date: 11/20/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays a detailed profile page for a specific user, consolidating all account and activity data.
  #              The page uses several partials to structure the content into sections for account information,
  #              activity statistics, owned portfolios, shared permissions, and recent investment activities.
  #
  # Usage:: - What: Renders the user's comprehensive profile view within the dashboard layout.
  #         - How: This partial is rendered from the **UsersController#show** action, receiving the **@user** instance variable.
  #         - Why: Provides a single, centralized view for account management, security auditing, and tracking investment activity.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure consistency; it is used as the main
  #               container and works by setting the page title and descriptive email.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @user.full_name,
           page_desc: "Conta de #{@user.email}",
           current_view: "show" do
%>

  <%# Explanation:: This section groups high-level account summary cards to provide
    #               an immediate overview; it is used to organize general user data
    #               and works by creating a flexible grid with an edit action button.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Informações da Conta",
             section_desc: "Dados gerais do usuário",
             columns: 4,
             has_action: true,
             button_route: edit_user_path(@user),
             button_name: "Editar",
             button_icon: "pencil" do
  %>

    <%# Explanation:: This card displays the user's name and role to verify security
      #               permissions; it is used to identify the account level and
      #               works by highlighting the internal role with a distinct color.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Nome Completo",
               card_icon: "user",
               card_data: "@#{@user.role}",
               is_danger: true do
    %>
      <%= @user.full_name %>
    <% end %>

    <%# Explanation:: This card counts how many portfolios the user owns to track
      #               self-managed assets; it is used to show active ownership
      #               and works by querying the total count from the portfolio list.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Carteiras Próprias",
               card_icon: "wallet",
               is_success: true do %>
      <%= @user.portfolios.count %>
    <% end %>

    <%# Explanation:: This card displays the count of portfolios shared by others
      #               to monitor collaboration; it is used to show external access
      #               and works by checking permissions linked to this user.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Acessos Compartilhados",
               card_icon: "users" do %>
      <%= @user.accessible_portfolios.count %>
    <% end %>
  <% end %>

  <%# Explanation:: This section organizes technical logs and login statistics
    #               to assist with security audits; it is used to track behavior
    #               and works by grouping data points like IPs and timestamps.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Estatísticas de Atividade",
             columns: 4 do
  %>

    <%# Explanation:: This card shows the total lifetime sign-ins to measure
      #               long-term engagement; it is used for auditing and works
      #               by displaying the count alongside the account creation date.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Total de Logins",
               card_icon: "log-in",
               card_data: "Desde #{formatted_timestamp(@user.created_at)}".html_safe do %>
      <%= @user.sign_in_count %>
    <% end %>

    <%# Explanation:: This card identifies the timestamp and IP of the previous session
      #               to spot unauthorized access; it is used for safety and works
      #               by fetching the last recorded connection data.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Último Acesso",
               card_icon: "globe",
               card_data: @user.last_sign_in_ip || "N/A" do %>
      <%= @user.last_sign_in_at ? formatted_timestamp(@user.last_sign_in_at) : "Nunca" %>
    <% end %>

    <%# Explanation:: This card displays current session details to confirm real-time
      #               connection data; it is used for active monitoring and works
      #               by showing the IP and start time of the ongoing visit.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Acesso Atual",
               card_icon: "globe",
               card_data: @user.current_sign_in_ip || "N/A" do %>
      <%= @user.current_sign_in_at ? formatted_timestamp(@user.current_sign_in_at) : "N/A" %>
    <% end %>

    <%# Explanation:: This card highlights when the account was first established
      #               to show seniority; it is used to provide member context and
      #               works by calculating the time elapsed since registration.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Conta Criada",
               card_icon: "user-plus",
               card_data: "Há #{time_ago_in_words(@user.created_at)}" do %>
      <%= formatted_timestamp(@user.created_at) %>
    <% end %>
  <% end %>

  <%# Explanation:: This table lists all portfolios belonging to the user in a
    #               searchable format; it is used for detailed management and
    #               works by formatting fund counts and values into structured rows.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Portfólios Próprios",
             collection: @user.portfolios,
             action_path: new_portfolio_path(user_id: @user.id),
             action_name: "Novo portfólio",
             headers: ["Nome da Carteira", "Fundos", "Valor Total", "Alocação", "Criado em"],
             column_icons: ["wallet", "layers", "coins", "shuffle", "calendar"],
             body_procs: [
               ->(portfolio) { link_to(portfolio.name, portfolio_path(portfolio), class: "hover:underline") },
               ->(portfolio) { colored_numerical(portfolio.fund_investments.count) },
               ->(portfolio) { colored_currency(portfolio.total_invested_value) },
               ->(portfolio) {
                 status = portfolio.valid_allocations? ? "success" : "danger"
                 label = portfolio.valid_allocations? ? "Válida" : "Inválida"
                 content_tag(:span, label, class: "badge badge-#{status}")
               },
               ->(portfolio) { formatted_timestamp(portfolio.created_at) }
             ]
  %>

  <%# Explanation:: This table lists external portfolios where the user is a
    #               collaborator to ensure transparency; it is used to track
    #               shared access and works by detailing owners and permission levels.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Permissões de Acesso",
             collection: @user.user_portfolio_permissions.includes(portfolio: :user),
             headers: ["Portfólio", "Proprietário", "Nível de Permissão", "Concedido em"],
             column_icons: ["layers", "user", "shield-user", "calendar-check-2"],
             body_procs: [
               ->(perm) { link_to(perm.portfolio.name, portfolio_path(perm.portfolio), class: "hover:underline") },
               ->(perm) { perm.portfolio.user.full_name },
               ->(perm) { content_tag(:span, perm.permission_level.capitalize, class: "badge badge-secondary") },
               ->(perm) { formatted_timestamp(perm.created_at) }
             ]
  %>

  <%# Explanation:: This container sets up a side-by-side view for movement logs
  #               to simplify verification; it is used to compare activity and
  #               works by placing applications and redemptions in two columns.
  %>
  <%= render "partials/route/dashboard/section",
             columns: 2,
             has_action: false do
  %>

    <%# Explanation:: This list shows the five most recent deposits to highlight
      #               positive growth; it is used to track inflows and works by
      #               fetching the latest applications and applying a success color.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Atividade de Aplicações",
               section_columns: 1,
               collection: Application.joins(fund_investment: :portfolio)
                                      .where(portfolios: { user_id: @user.id })
                                      .includes(fund_investment: [:portfolio, :investment_fund])
                                      .order(request_date: :desc).limit(5),
               color: "success",
               see_all_path: applications_path(q: { fund_investment_portfolio_user_id_eq: @user.id }),
               title_proc: ->(app) { app.fund_investment.investment_fund.fund_name },
               value_proc: ->(app) { "+ R$#{app.financial_value}" },
               sub_value_proc: ->(app) { app.fund_investment.portfolio.name } %>

    <%# Explanation:: This list displays the five most recent withdrawals to monitor
      #               cash outflows; it is used to track liquidity and works by
      #               showing redemptions with a distinct danger theme.
      %>
    <%= render "partials/groups/recent_activity",
               section_title: "Atividade de Resgates",
               section_columns: 1,
               collection: Redemption.joins(fund_investment: :portfolio)
                                     .where(portfolios: { user_id: @user.id })
                                     .includes(fund_investment: [:portfolio, :investment_fund])
                                     .order(request_date: :desc).limit(5),
               color: "danger",
               see_all_path: redemptions_path(q: { fund_investment_portfolio_user_id_eq: @user.id }),
               title_proc: ->(red) { red.fund_investment.investment_fund.fund_name },
               value_proc: ->(red) { "- R$#{red.redeemed_liquid_value}" },
               sub_value_proc: ->(red) { red.fund_investment.portfolio.name } %>
  <% end %>
<% end %>