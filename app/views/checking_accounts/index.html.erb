<%#
  # Partial: index.html.erb
  # Date: 02/22/2026
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Constrói a página de listagem das contas correntes de um portfólio.
  #              Exibe uma tabela de dados com seletor de mês de referência e filtros
  #              por instituição e nome de conta.
  #
  # Usage:: - What: Renderiza a visão de índice para o recurso CheckingAccount,
  #                escopado ao @portfolio corrente, com suporte a filtro por período.
  #         - How: Usa o wrapper do dashboard, o partial data-table e o partial filters.
  #               O mês de referência é controlado via parâmetro `?month=YYYY-MM`.
  #         - Why: Centraliza a visualização de disponibilidades em conta corrente
  #                do portfólio, permitindo análise mês a mês.
  %>

<%# Explanation:: Este wrapper organiza o conteúdo da página no layout padrão do
  #               dashboard, definindo o título com o nome do portfólio e uma
  #               descrição contextual do período exibido.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: "Contas Correntes",
           page_desc: "#{@portfolio.name} — #{l(@reference_date, format: :month_year)}",
           current_view: "datatable" do
%>

  <%# Explanation:: Este seletor de mês permite ao usuário navegar entre os períodos
    #               disponíveis sem recarregar a página inteira, filtrando os saldos
    #               exibidos na tabela abaixo.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Período de Referência",
             columns: 1 do
  %>
    <%= form_with url: portfolio_checking_accounts_path(@portfolio), method: :get, local: true do |f| %>
      <%= render "partials/modules/select",
                 f: f,
                 name: :month,
                 label: "Mês de referência",
                 desc: "Selecione o mês para visualizar os saldos das contas correntes.",
                 is_half_width: true,
                 options_collection: @available_months.map { |d|
                   [l(d, format: :month_year), d.strftime('%Y-%m')]
                 },
                 selected: params[:month],
                 is_inactive: @available_months.empty?
      %>
      <%= f.submit "Aplicar", class: "button button-small button-secondary w-fit" %>
    <% end %>
  <% end %>

  <%# Explanation:: Esta seção exibe um KPI de destaque com o saldo total consolidado
    #               de todas as contas correntes no mês selecionado, permitindo ao
    #               gestor visualizar o total de disponibilidades de forma imediata.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Total de Disponibilidades",
             columns: 4 do
  %>
    <%= render(
          "partials/route/dashboard/card",
          card_title: "Saldo Total em Conta Corrente",
          card_icon: "bank",
          card_data: normalize_card_text(l(@reference_date, format: :month_year))
        ) do
    %>
      <%= normalize_currency(@total_balance) %>
    <% end %>
  <% end %>

  <%# Explanation:: Esta tabela lista todas as contas correntes do portfólio para
    #               o mês selecionado, com colunas de instituição, nome, número e
    #               saldo. A tabela é integrada ao Turbo Frame para atualizações
    #               parciais sem reload completo.
    %>
  <%= render partial: "partials/blocks/data-table", locals: {

    # Explanation:: Cabeçalhos descrevendo cada coluna da tabela de contas correntes.
    columns_header: [
      "Instituição",
      "Nome",
      "Número",
      "Saldo",
    ],

    # Explanation:: Ícones Material Symbols associados a cada coluna para
    #               facilitar o reconhecimento visual do tipo de dado.
    columns_icons: [
      "landmark",
      "tag",
      "hash",
      "banknote",
      "file-text"
    ],

    # Explanation:: Lambdas responsáveis por extrair e formatar cada campo
    #               de uma CheckingAccount para exibição na linha da tabela.
    columns_body: [
      ->(ca) { normalize_code(ca.institution_label) },

      ->(ca) { normalize_title(ca.name) },

      ->(ca) { normalize_number(ca.account_number) },

      ->(ca) { normalize_currency(ca.balance) },
    ],

    # Explanation:: Coleção de contas correntes do mês filtrado, já ordenada
    #               por instituição e nome para facilitar a leitura.
    models: @checking_accounts,

    new_path: new_portfolio_checking_account_path(@portfolio),

    sort_options: [],
    q_object: @q,

    # Explanation:: URL base para busca e paginação, mantendo o parâmetro de
    #               portfólio e mês de referência no contexto correto.
    search_url: portfolio_checking_accounts_path(@portfolio, month: params[:month]),

    turbo_frame_id: "checking_accounts_table",

    export_url: nil
  } %>
<% end %>

<%# Explanation:: Filtros laterais por instituição e nome de conta, permitindo
  #               refinamento rápido da listagem sem recarregar a página inteira.
  %>
<%= render partial: "partials/route/dashboard/filters",
           locals: {
             q_object: @q,
             search_url: portfolio_checking_accounts_path(@portfolio, month: params[:month]),
             filters: [
               {
                 key: :institution_cont,
                 label: "Instituição",
                 description: "Filtra contas cuja instituição contenha este texto.",
                 placeholder: "Bradesco",
                 icon_name: "bank"
               },
               {
                 key: :name_cont,
                 label: "Nome / Descrição",
                 description: "Filtra contas cujo nome ou descrição contenha este texto.",
                 placeholder: "CC Principal",
                 icon_name: "tag"
               }
             ],
             turbo_frame_id: "checking_accounts_table"
           }
%>
