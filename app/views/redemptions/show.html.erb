<%= render 'partials/route/dashboard/wrapper',
           page_title: "Resgate ##{@redemption.id}",
           page_desc: "Retirada de #{@redemption.fund_investment.investment_fund.fund_name}",
           current_view: "show" do
%>

  <%= render "partials/route/dashboard/section",
             section_title: "Informações do Resgate",
             section_desc: "Dados da transação de retirada",
             columns: 4,
             has_action: false do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Fundo de Investimento",
               card_icon: "building-2",
               status: :teal do
    %>
      <%= normalize_text(@redemption.fund_investment.investment_fund.fund_name) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Portfólio",
               card_icon: "wallet" do
    %>
      <%= normalize_text(@redemption.fund_investment.portfolio.name) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Investimento Relacionado",
               card_icon: "link",
               card_data: normalize_card_percentage(@redemption.fund_investment.percentage_allocation),
               card_data_icon: "percent" do
    %>
      <%= normalize_text("Alocação #{@redemption.fund_investment.id}") %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Status",
               card_icon: card_icon_boolean_for(redemption_status_text(@redemption)[:completed]),
               card_data: redemption_status_text(@redemption)[:status_text],
               card_data_icon: card_icon_boolean_for(redemption_status_text(@redemption)[:completed]),
               status: card_status_boolean_for(redemption_status_text(@redemption)[:completed], positive: :success, negative: :alert) do
    %>
      <%= normalize_text(redemption_status_text(@redemption)[:detail_text]) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Valores Financeiros",
             section_desc: "Montantes e rendimentos do resgate",
             columns: 4 do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Valor Líquido Resgatado",
               card_icon: "banknote" do
    %>
      <%= normalize_currency(@redemption.redeemed_liquid_value) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Cotas Resgatadas",
               card_icon: "coins" do
    %>
      <%= normalize_number(@redemption.redeemed_quotas) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Valor Efetivo da Cota",
               card_icon: "chart-line" do
    %>
      <%= normalize_currency(@redemption.effective_quota_value) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Rendimento do Resgate",
               card_icon: card_data_icon_for(redemption_metrics(@redemption)[:yield_value], zero: "minus", positive: "smile", negative: "frown"),
               status: card_status_trend_for(redemption_metrics(@redemption)[:yield_value]) do
    %>
      <%= normalize_trend(redemption_metrics(@redemption)[:yield_value], format: :currency) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Tipo e Classificação",
             section_desc: "Categoria e características do resgate",
             columns: 4 do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Tipo de Resgate",
               card_icon: "tag" do
    %>
      <%= normalize_text(redemption_type_label(@redemption)) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Aplicações Vinculadas",
               card_icon: "git-branch" do
    %>
      <%= normalize_number(@redemption.redemption_allocations.count) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Ciclo de Vida da Transação",
             section_desc: "Datas e etapas do processo de resgate",
             columns: 4 do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Data de Solicitação",
               card_icon: "calendar-plus" do
    %>
      <%= normalize_date(@redemption.request_date) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Data de Cotização",
               card_icon: "calendar-check-2" do
    %>
      <%= normalize_date(@redemption.cotization_date) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Data de Liquidação",
               card_icon: "calendar-check-2" do
    %>
      <%= normalize_date(@redemption.liquidation_date) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Análise de Alocação FIFO",
             section_desc: "Distribuição de cotas entre aplicações originais",
             columns: 2 do
  %>

    <%= render "partials/groups/chart-list",
               chart_type: :column_chart,
               data_source: redemption_performance_data(@redemption)[:allocation_status],
               chart_title: "Status de Alocação de Cotas",
               chart_options: {
                 library: {
                   legend: { display: true }
                 }
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: redemption_allocation_by_app(@redemption),
               chart_title: "Distribuição por Aplicação Original",
               chart_options: {
                 donut: true,
                 legend: "right",
                 library: {
                   plugins: {
                     legend: {
                       position: 'right'
                     }
                   }
                 }
               }
    %>

  <% end %>

  <%= render "partials/groups/table-list",
             section_title: "Alocações FIFO Detalhadas",
             collection: @redemption.redemption_allocations.includes(:application),
             action_path: nil,
             action_name: nil,
             headers: [
               "Aplicação Original",
               "Data da Aplicação",
               "Cotas Utilizadas",
               "Cotação na Aplicação",
               "Valor Original",
               "Percentual do Resgate"
             ],
             column_icons: [
               "briefcase",
               "calendar",
               "percent",
               "calculator",
               "banknote",
               "badge-percent"
             ],
             body_procs: [
               ->(alloc) do
                 normalize_title("Aplicação ##{alloc.application.id}")
               end,
               ->(alloc) do
                 normalize_date(alloc.application.request_date)
               end,
               ->(alloc) do
                 normalize_number(alloc.quotas_used)
               end,
               ->(alloc) do
                 normalize_currency(alloc.application.quota_value_at_application)
               end,
               ->(alloc) do
                 quota_price = alloc.application&.quota_value_at_application

                 return normalize_no_data if alloc.quotas_used.blank? || quota_price.blank?

                 original_value = alloc.quotas_used * quota_price

                 normalize_currency(original_value)
               end,
               ->(alloc) do
                 percentage = (alloc.quotas_used / @redemption.redeemed_quotas * 100)

                 normalize_percentage(percentage)
               end,
             ]
  %>

  <%= render "partials/route/dashboard/section",
             section_title: "Análise de Rendimento",
             section_desc: "Comparação entre valor investido e resgatado",
             columns: 2 do
  %>

    <%= render "partials/groups/chart-list",
               chart_type: :column_chart,
               data_source: redemption_performance_data(@redemption)[:investment_vs_redemption],
               chart_title: "Investimento vs Resgate",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 colors: ["#6366f1", "#10b981"]
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: redemption_performance_data(@redemption)[:composition],
               chart_title: "Composição do Valor Resgatado",
               chart_options: {
                 prefix: "R$ ",
                 thousands: ".",
                 decimal: ",",
                 donut: true,
                 legend: "right"
               }
    %>

  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Resumo de Performance",
             columns: 4,
             has_action: false do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Capital Investido Total",
               card_icon: "dollar-sign" do
    %>
      <%= normalize_currency(redemption_metrics(@redemption)[:total_invested]) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Ganhos e Perdas Líquidas",
               card_icon: card_data_icon_for(
                 redemption_metrics(@redemption)[:net_gain],
                 zero: "minus",
                 positive: "smile",
                 negative: "frown"
               ),
               status: card_status_trend_for(redemption_metrics(@redemption)[:net_gain]) do
    %>
      <%= normalize_trend(redemption_metrics(@redemption)[:net_gain], format: :currency) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Custo Médio da Cota",
               card_icon: "chart-bar-stacked" do
    %>
      <%= normalize_currency(redemption_metrics(@redemption)[:avg_quota_cost]) %>
    <% end %>
  <% end %>

<% end %>
