<%#
  # Partial: index.html.erb
  # Date: 11/25/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays a comprehensive, filterable data table containing the entire history of investment applications and redemption transactions.
  #              The view fetches and presents application data using a customizable data table partial.
  #
  # Usage: - What: Renders a structured page that allows the user to review, sort, and filter all registered investment transactions.
  #                This serves as the central history log for financial activity.
  #        - How: Accessed via the resource index route (GET /applications).
  #               Utilizes Ransack (@q object) for searching and filtering the @applications collection.
  #        - Why: Provides necessary transparency and auditing capabilities for the user's investment portfolio history.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure visual consistency. It acts as the
  #               main container by setting the page title and descriptive labels.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: "Lista de Aplicações",
           page_desc: "Visualize todas as transações de investimento e resgate registradas.",
           current_view: "datatable" do
%>

  <%# Explanation:: This partial generates a dynamic table to list application records
    #               clearly. It presents organized data to the user and works by
    #               receiving headers and data-fetching logic as local arguments.
    %>
  <%= render partial: "partials/blocks/data-table", locals: {

    # Explanation:: This array defines the text labels displayed at the top of
    #               the table columns. It provides vital context for each field
    #               and works by mapping each string to a specific header cell.
    columns_header: [
      "Aplicação",
      "Carteira",
      "Valor",
      "Cotas",
      "Valor da cota",
      "Alocação de resgate",
      "Pedido em",
      "Liquidado em",
    ],

    # Explanation:: This collection holds visual icons to accompany the column
    #               titles for better recognition. It beautifies the header and
    #               works by rendering specific symbols for each data type.
    columns_icons: [
      "briefcase",
      "wallet",
      "banknote",
      "percent",
      "calculator",
      "arrow-down-to-line",
      "calendar-plus",
      "calendar-check-2"
    ],

    # Explanation:: This list contains the logic for filling each row with specific
    #               application details. It handles all data extraction and works
    #               by executing formatting functions for every record in the list.
    columns_body: [

      # Explanation:: This function identifies and labels the name of the fund
      #               linked to the transaction. It ensures the primary asset is
      #               visible and works by safely navigating the investment links.
      ->(app) do
        normalize_title(app.fund_investment&.investment_fund&.fund_name)
      end,

      # Explanation:: This logic displays the specific portfolio name where the
      #               investment resides. It clarifies asset location and works
      #               by rendering the name in a distinct, uppercase mono font.
      ->(app) do
        normalize_fk(app.fund_investment&.portfolio&.name)
      end,

      # Explanation:: This instruction formats the total financial value into a
      #               standardized currency layout. It highlights the transaction
      #               scale and works by converting raw numbers into Brazilian Reais.
      ->(app) do
        normalize_currency(app.financial_value)
      end,

      # Explanation:: This line displays the quantity of ownership units acquired
      #               during the transaction. It shows the investment volume and
      #               works by applying clean numerical formatting to the quota count.
      ->(app) do
        normalize_number(app.number_of_quotas)
      end,

      # Explanation:: This function shows the price per quota used at the moment
      #               of application. It provides a price reference point and
      #               works by rendering the unit value in a clear currency format.
      ->(app) do
        normalize_currency(app.quota_value_at_application)
      end,

      ->(app) do
        # Explanation:: This condition verifies if the quota count is defined.
        #               If the record lacks this data, it returns a pending
        #               status badge to signal that the setup is incomplete.
        return normalize_badge("Pendente") if app.number_of_quotas.blank?

        # Explanation:: This line calculates the current allocation volume.
        #               It subtracts available quotas from the total to show
        #               how much of the investment has already been distributed.
        allocated = app.number_of_quotas - app.available_quotas

        # Explanation:: This line builds the descriptive allocation label.
        #               It combines the current usage with the total capacity
        #               using standard numeric formatting for easy comparison.
        label = safe_join(
          [
            allocated,
            " / ",
            app.number_of_quotas
          ]
        )
        # Explanation:: This call utilizes the boolean badge helper for status.
        #               It assigns a red style if the item is fully allocated
        #               and a green style if there is still room for more quotas.
        normalize_boolean(app.fully_allocated?, label, label)
      end,

      # Explanation:: This instruction presents the exact date when the user
      #               requested the transaction. It tracks the start of the
      #               process and works by applying a friendly timestamp format.
      ->(app) do
        normalize_date(app.request_date)
      end,

      # Explanation:: This logic shows the completion date when the transaction
      #               was fully settled. It confirms the finalization and works
      #               by converting the liquidation date into a readable string.
      ->(app) do
        normalize_date(app.liquidation_date)
      end,
    ],

    # Explanation:: This attribute provides the actual list of application objects
    #               retrieved from the database. It serves as the primary data
    #               source and works by feeding records into the table display loop.
    models: @applications,

    # Explanation:: This configuration sets the rules for how users can reorder
    #               the transaction list. It allows for custom sorting and
    #               works by integrating with the active search parameters.
    sort_options: [],

    # Explanation:: This object manages the current search and sort criteria
    #               for the applications list. It tracks user filters and
    #               works by generating valid database queries via the Ransack gem.
    q_object: @q,

    # Explanation:: This path tells the table where to send search and page
    #               requests. It keeps the user on the correct page and
    #               works by linking actions to the main applications route.
    search_url: applications_path,

    # Explanation:: This unique identifier allows the table to update without
    #               refreshing the entire page. It improves speed and works
    #               by isolating table content within a specific Turbo Frame.
    turbo_frame_id: "applications_table",

    # Explanation:: This setting provides a link for users to download the
    #               history data as an external file. It enables reporting
    #               features and works by activating an export button when set.
    export_url: nil
  } %>
<% end %>

<%# Explanation:: This partial renders a sidebar with search inputs to help
  #               users find specific history records. It refines the list
  #               and works by sending form data to the table's Turbo Frame.
  %>
<%= render partial: "partials/route/dashboard/filters", locals: {

  # Explanation:: This search object connects the filter fields to the active
  #               query logic. It initializes the input values and works
  #               by syncing with the current database search parameters.
  q_object: @q,

  # Explanation:: This destination URL determines where the search filters
  #               are sent upon submission. It updates the displayed data
  #               and works by targeting the main applications list route.
  search_url: applications_path,

  # Explanation:: This list defines the specific text and icon for each
  #               filter box. It builds the search form and works by
  #               generating inputs for fund names, values, and dates.
  filters: [
    {
      key: :fund_investment_investment_fund_fund_name_cont,
      label: "Fundo",
      description: "Exibe aplicações vinculadas a um fundo específico.",
      placeholder: "Nome do fundo",
      icon_name: "chart-pie"
    },
    {
      key: :financial_value_gteq,
      label: "Valor transacionado",
      description: "Filtra transações com valor igual ou superior ao informado.",
      placeholder: "Valor mínimo em reais",
      icon_name: "banknote"
    },
    {
      key: :request_date_gteq,
      label: "Data do pedido (Min.)",
      description: "Filtra transações solicitadas a partir desta data.",
      placeholder: "28/02/2019",
      icon_name: "calendar"
    }
  ],

  # Explanation:: This ID links the filter results directly to the table
  #               container for seamless updates. It prevents full page
  #               reloads and works by targeting the correct Turbo Frame.
  turbo_frame_id: "applications_table"
} %>
