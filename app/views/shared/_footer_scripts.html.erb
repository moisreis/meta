<%#
  # Partial: _footer_scripts.html
  # Date: 11/26/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Loads and initializes client-side JavaScript needed by views
  #              that rely on enhanced form controls. Ensures the TomSelect
  #              component is properly attached to its corresponding input field.
  #
  # Usage:
  #   - What: Injects page-specific scripts at the bottom of the layout.
  #           Initializes TomSelect for elements that require advanced select UI.
  #   - How: Render this partial inside the main layout or inside a view that
  #          needs TomSelect active on an element with id `tom-select-it`.
  #   - Why: Keeps script initialization centralized, improves readability,
  #          avoids duplicate JavaScript blocks in multiple templates, and
  #          ensures consistent behavior across pages using the same widgets.
  %>

<!-- [Libary] TomSelect -->
<script>
    var settings = {
        create: false,
        allowEmptyOption: true,
        maxItems: 1,
        sortField: {
            field: 'text',
            direction: 'asc'
        },
        placeholder: 'Escolha uma opção',
        searchField: ['text'],
        plugins: {
            dropdown_input: {},
        },
        render: {
            option: function (data, escape) {
                return '<div class="option">' + escape(data.text) + '</div>';
            }
        }
    };

    document.querySelectorAll('.js-tomselect').forEach(function (selectEl) {
        new TomSelect(selectEl, settings);
    });
</script>

<!-- [Libary] Flatpickr -->
<script>
    flatpickr(".datetime", {
        dateFormat: "d/m/Y",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: false,
        disableMobile: true,
        monthSelectorType: "static",
        yearSelectorType: "static",
        prevArrow: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left-icon lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                   `,
        nextArrow: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right-icon lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                   `,

        locale: {
            firstDayOfWeek: 1,
            weekdays: {
                shorthand: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"],
                longhand: [
                    "Domingo",
                    "Segunda-feira",
                    "Terça-feira",
                    "Quarta-feira",
                    "Quinta-feira",
                    "Sexta-feira",
                    "Sábado",
                ]
            },
            months: {
                shorthand: [
                    "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
                    "Jul", "Ago", "Set", "Out", "Nov", "Dez"
                ],
                longhand: [
                    "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
                ]
            }
        }
    });
</script>

<!-- [Libary] Tippy.js -->
<script>
    document.addEventListener('DOMContentLoaded', () => {

        tippy('.row-options-button', {

            content(reference) {
                const targetSelector = reference.dataset.tippyTarget;

                if (targetSelector) {
                    const contentElement = document.querySelector(targetSelector);

                    return contentElement ? contentElement.innerHTML : 'Menu not found';
                }
                return 'Error loading menu content.';
            },

            allowHTML: true,
            placement: 'bottom',
            theme: 'meta',
            arrow: false,
            interactive: true,
            offset: [4, 0]
        });

        tippy('.section-desc-button', {

            content(reference) {
                const targetSelector = reference.dataset.tippyTarget;

                if (targetSelector) {
                    const contentElement = document.querySelector(targetSelector);

                    return contentElement ? contentElement.innerHTML : 'Description not found';
                }
                return 'Error loading description content.';
            },

            appendTo: () => document.body,

            allowHTML: true,
            placement: 'right',
            theme: 'meta',
            arrow: false,
            interactive: false,
            offset: [0, 4]
        });
    });
</script>

<!-- [Script] sidebarFilters -->
<script>
    let sidebar;
    let openBtn;
    let closeBtn;
    let filterOverlay;

    function openSidebar() {
        sidebar.classList.add('opacity-100');
        sidebar.classList.remove('opacity-0', 'pointer-events-none');
        filterOverlay.classList.remove('hidden');
    }

    function closeSidebar() {
        sidebar.classList.remove('opacity-100');
        sidebar.classList.add('opacity-0', 'pointer-events-none');
        filterOverlay.classList.add('hidden');
    }

    function setupEventListeners() {
        sidebar = document.getElementById('sidebarFilters');
        openBtn = document.getElementById('openFiltersBtn');
        closeBtn = document.getElementById('closeFiltersBtn');
        filterOverlay = document.getElementById('filterOverlay')

        if (sidebar && openBtn && closeBtn) {
            openBtn.addEventListener('click', openSidebar);
            closeBtn.addEventListener('click', closeSidebar);
        } else {
            console.error("Sidebar setup failed: One or more IDs were not found in the HTML.");
        }
    }

    document.addEventListener('DOMContentLoaded', setupEventListeners);
</script>

<script>
    document.addEventListener("click", function (event) {
        const button = event.target.closest(".js-export-chart");
        if (!button) return;

        event.preventDefault();

        const chartId = button.dataset.chartId;
        const rawTitle = button.dataset.chartTitle || "";

        const chart = Chartkick.charts[chartId];
        if (!chart || !chart.getChartObject) return;

        const sourceCanvas = chart.getChartObject().canvas;

        const padding = 32;
        const headerHeight = 48;

        const exportCanvas = document.createElement("canvas");
        exportCanvas.width = sourceCanvas.width + padding * 2;
        exportCanvas.height = sourceCanvas.height + padding * 2 + headerHeight;

        const ctx = exportCanvas.getContext("2d");

        // Background
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

        // Header text style
        ctx.fillStyle = "#8a8a8a"; // gray-900
        ctx.font = "400 14px Geist Pixel Square, system-ui, sans-serif";
        ctx.textBaseline = "middle";

        // Title (TOP-LEFT, UPPERCASE)
        ctx.textAlign = "left";
        ctx.fillText(
            rawTitle.toUpperCase(),
            padding,
            headerHeight / 2
        );

        // Date/time (TOP-RIGHT, pt-BR)
        const formattedDate = new Date().toLocaleString("pt-BR", {
            dateStyle: "short",
            timeStyle: "short"
        });

        ctx.textAlign = "right";
        ctx.fillText(
            formattedDate,
            exportCanvas.width - padding,
            headerHeight / 2
        );

        // Draw chart
        ctx.drawImage(
            sourceCanvas,
            padding,
            headerHeight + padding
        );

        // Download
        const link = document.createElement("a");
        link.href = exportCanvas.toDataURL("image/png");
        link.download = `${chartId}.png`;
        link.click();
    });


</script>

<script>
    // Explanation:: This script watches the portfolio dropdown for changes.
    //               When a new option is picked, it updates the button's link.
    //               This prevents the user from going to the wrong portfolio.
    document.addEventListener('change', (event) => {
        if (event.target.name === 'portfolio_id') {
            const link = document.getElementById('view-portfolio-link');
            const selectedId = event.target.value;
            const baseUrl = link.dataset.baseUrl;

            if (selectedId) {
                link.href = baseUrl + selectedId;
            }
        }
    });
</script>
