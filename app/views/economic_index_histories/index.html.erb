<%#
  # Partial: index.html.erb
  # Date: 12/23/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Renders the historical data list for economic indicators. It shows
  #              a timeline of recorded values, price variations, and allows for
  #              granular filtering by date or index type.
  #
  # Usage: - What: Displays a comprehensive table of all recorded historical values
  #                for one or all economic indices.
  #        - How: Renders within a dashboard wrapper and utilizes a data-table
  #               partial to process and display the **@economic_index_histories** collection.
  #        - Why: Enables administrators and users to audit historical changes and
  #               verify the accuracy of the data points that drive fund calculations.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure to ensure visual consistency. It dynamically
  #               adjusts the title to show either a specific index name or a
  #               general history overview based on the current search context.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @economic_index ? "Histórico - #{@economic_index.name}" : "Histórico de Índices Econômicos",
           page_desc: @economic_index ? "#{@economic_index.abbreviation}" : "Visualize os valores históricos registrados para os indicadores econômicos.",
           current_view: "datatable" do
%>

  <%# Explanation:: This component generates a dynamic table to list historical price
    #               points clearly. It handles row formatting and works by
    #               receiving the history collection along with specific column definitions.
    %>
  <%= render partial: "partials/blocks/data-table", locals: {

    columns_header: [
      "Índice",
      "Data",
      "Valor",
      "Variação",
      "Porcentagem",
      "Registrado há"
    ],

    columns_icons: [
      "trending-up",
      "timeline-event",
      "attachment",
      "coins-swap",
      "percent",
      "time-schedule"
    ],

    columns_body: [

      ->(history) do
        normalize_title(history.economic_index.abbreviation)
      end,

      ->(history) do
        normalize_date(history.date)
      end,

      ->(history) do
        normalize_number(history.value)
      end,

      ->(history) do
        normalize_trend(history.change_from_previous)
      end,

      ->(history) do
        normalize_trend(history.percentage_change_from_previous, format: :percentage)
      end,

      ->(history) do
        normalize_date(history.created_at)
      end
    ],

    models: @economic_index_histories,

    sort_options: [],

    q_object: @q,

    search_url: @economic_index ? economic_index_economic_index_histories_path(@economic_index) : economic_index_histories_path,

    turbo_frame_id: "economic_index_histories_table",

    export_url: nil
  } %>
<% end %>

<%# Explanation:: This partial renders a sidebar with search inputs to help
  #               users filter historical data by date or value. It refines
  #               the list and works by sending form data to the Turbo Frame.
  %>
<%= render partial: "partials/route/dashboard/filters", locals: {

  # Explanation:: This search object connects the filter fields to the active
  #               query logic. It initializes the input values and works
  #               by syncing with the current database search parameters.
  q_object: @q,

  # Explanation:: This destination URL determines where the search filters
  #               are sent upon submission. It updates the displayed data
  #               and works by targeting the history index route.
  search_url: @economic_index ? economic_index_economic_index_histories_path(@economic_index) : economic_index_histories_path,

  # Explanation:: This list defines the specific text and icon for each filter
  #               box. It builds the search form and works by generating
  #               inputs for abbreviations, date ranges, and numeric values.
  filters: [
    (@economic_index ? nil : {
      key: :economic_index_abbreviation_cont,
      label: "Índice",
      description: "Filtra por sigla do índice econômico (ex: IPCA, CDI).",
      placeholder: "Sigla do índice",
      icon_name: "hash"
    }),
    {
      key: :date_gteq,
      label: "Data Inicial",
      description: "Mostra registros a partir desta data.",
      placeholder: "Data inicial",
      icon_name: "calendar",
      field_type: :date_field
    },
    {
      key: :date_lteq,
      label: "Data Final",
      description: "Mostra registros até esta data.",
      placeholder: "Data final",
      icon_name: "calendar",
      field_type: :date_field
    },
    {
      key: :value_gteq,
      label: "Valor Mínimo",
      description: "Filtra valores maiores ou iguais a este número.",
      placeholder: "Valor mínimo",
      icon_name: "trending-up",
      field_type: :number_field
    },
    {
      key: :value_lteq,
      label: "Valor Máximo",
      description: "Filtra valores menores ou iguais a este número.",
      placeholder: "Valor máximo",
      icon_name: "trending-down",
      field_type: :number_field
    }
  ].compact,

  # Explanation:: This ID links the filter results directly to the history
  #               table container for seamless updates. It prevents full
  #               page reloads and works by targeting the correct Turbo Frame.
  turbo_frame_id: "economic_index_histories_table"
} %>