<%= render 'partials/route/dashboard/wrapper',
           page_title: "Visão Geral",
           page_desc: "Painel de #{current_user.full_name}",
           current_view: "index" do
%>

  <%= render "partials/route/dashboard/section",
             section_title: "Resumo de Investimentos",
             section_desc: "Métricas consolidadas de todas as suas carteiras",
             columns: 4,
             has_action: false do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Total Investido",
               card_icon: "wallet" do
    %>
      <%= normalize_currency(@total_invested) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Cotas Totais",
               card_icon: "coins" do
    %>
      <%= normalize_number(@total_quotas) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Carteiras Ativas",
               card_icon: "briefcase" do
    %>
      <%= normalize_number(current_user.portfolios.count) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Fundos Distintos",
               card_icon: "building-2" do
    %>
      <%= normalize_number(@unique_funds) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Performance Consolidada",
             section_desc: "Análise de rentabilidade e posição atual",
             columns: 4 do
  %>

    <%= render "partials/route/dashboard/card",
               card_title: "Valor de Mercado Atual",
               card_icon: card_data_icon_for(@total_market_value) do
    %>
      <%= normalize_currency(@total_market_value) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Ganho e Perda Total",
               card_icon: card_data_icon_for(@total_gain_loss),
               status: card_status_trend_for(@total_gain_loss) do %>
      <%= normalize_currency(@total_gain_loss.abs) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Retorno Total",
               card_icon: card_data_icon_for(@roi),
               status: card_status_trend_for(@roi) do %>
      <%= normalize_percentage(@roi) %>
    <% end %>

    <%= render "partials/route/dashboard/card",
               card_title: "Total de Transações",
               card_icon: "repeat" do
    %>
      <%= normalize_number(@total_transactions) %>
    <% end %>
  <% end %>

  <%= render "partials/route/dashboard/section",
             section_title: "Visualizações",
             columns: 2 do
  %>

    <%= render "partials/route/dashboard/chart",
               data_source: @portfolio_allocation,
               chart_title: "Distribuição por Carteira",
               empty_message: "Nenhuma carteira com investimentos" do
    %>
      <%= pie_chart @portfolio_allocation,
                    prefix: "R$ ",
                    thousands: ".",
                    decimal: ",",
                    donut: true,
                    legend: "right"
      %>
    <% end %>

    <%= render "partials/route/dashboard/chart",
               data_source: @monthly_flows,
               chart_title: "Fluxo Mensal Consolidado",
               empty_message: "Nenhuma transação registrada" do
    %>
      <%= line_chart @monthly_flows,
                     stacked: false,
                     prefix: "R$ ",
                     thousands: ".",
                     decimal: ",",
                     curve: true,
                     library: {
                       scales: {
                         y: {
                           ticks: {
                             callback: "function(value) { return 'R$ ' + value.toLocaleString('pt-BR'); }"
                           }
                         }
                       }
                     }
      %>
    <% end %>
  <% end %>

  <%= render "partials/groups/table-list",
             section_title: "Suas Carteiras",
             collection: current_user.portfolios,
             headers: [
               "Nome da Carteira",
               "Fundos Alocados",
               "Valor Investido",
               "Valor de Mercado",
               "Retorno",
               "Status"
             ],
             column_icons: [
               "wallet",
               "coins",
               "banknote-arrow-up",
               "chart-line",
               "trending-up",
               "circle-check"
             ],
             body_procs: [

               ->(portfolio) do
                 normalize_title(portfolio.name)
               end,

               ->(portfolio) do
                 normalize_number(portfolio.fund_investments.count)
               end,

               ->(portfolio) do
                 normalize_currency(portfolio.total_invested_value)
               end,

               ->(portfolio) do
                 normalize_currency(portfolio.fund_investments.sum(&:current_market_value))
               end,

               ->(portfolio) do
                 normalize_trend(portfolio.total_invested_value.to_f.positive? ? ((portfolio.fund_investments.sum(&:current_market_value) - portfolio.total_invested_value.to_f) / portfolio.total_invested_value.to_f * 100) : 0, format: :percentage)
               end,

               ->(portfolio) do
                 normalize_boolean(
                   portfolio.valid_allocations?,
                   "Válida",
                   "Inválida"
                 )
               end
             ]
  %>

  <%= render "partials/route/dashboard/section",
             columns: 2,
             section_title: "Atividades recentes",
             has_action: false do
  %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               data_source: @recent_applications_chart,
               chart_title: "Últimas Aplicações",
               chart_options: {
                 prefix: "R$ ",
                 donut: true,
                 legend: "right"
               }
    %>

    <%= render "partials/groups/chart-list",
               chart_type: :pie_chart,
               download: { background: "#ffffff" },
               data_source: @recent_redemptions_chart,
               chart_title: "Últimos Resgates",
               chart_options: {
                 prefix: "R$ ",
                 donut: true,
                 legend: "right"
               }
    %>
  <% end %>
<% end %>