<%#
  # Partial: show.html.erb
  # Date: 12/4/2025
  # Author: Moisés Reis
  # Package: Meta
  #
  # Description: Displays the detailed view for a single normative article.
  #              It consolidates article information, benchmark data, associated
  #              investment funds, and metadata in a structured dashboard layout.
  #
  # Usage: - What: Renders the comprehensive detail page for a specific normative article.
  #                It allows users to review article content, benchmark targets, and related funds.
  #        - How: This partial is rendered from the NormativeArticlesController#show action, receiving
  #               the @normative_article instance variable, which represents the complete article record.
  #        - Why: Provides a single, centralized view for reviewing regulatory content, monitoring
  #               benchmark compliance, and understanding which funds follow this article.
  %>

<%# Explanation:: This layout wrapper organizes the entire page content into a clean
  #               dashboard structure. It displays the article name and identifies
  #               it as a normative article for clear context.
  %>
<%= render 'partials/route/dashboard/wrapper',
           page_title: @normative_article.display_name,
           page_desc: "Artigo Normativo",
           current_view: "show" do
%>

  <%# Explanation:: This section groups the primary identification data and administrative
    #               actions for the article. It provides a quick-access "Edit" button and
    #               works by organizing cards into a responsive grid for easy scanning.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Visão Geral",
             section_desc: "Informações básicas do artigo normativo",
             columns: 4,
             has_action: true,
             button_route: edit_normative_article_path(@normative_article),
             button_name: "Editar",
             button_icon: "pencil" do
  %>

    <%# Explanation:: This card displays the formal reference code or number assigned to
      #               the article in official records. It serves as the unique identifier
      #               for regulatory tracking and ensures the user can cross-reference laws.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Número do Artigo",
               card_icon: "file-text" do
    %>
      <%= @normative_article.article_number.presence || "N/A" %>
    <% end %>

    <%# Explanation:: This card presents the human-readable name of the normative rule to
      #               provide immediate clarity on its subject. It pulls the title directly
      #               from the database and ensures the regulatory topic is prominent.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Nome do Artigo",
               card_icon: "file-check" do
    %>
      <%= @normative_article.article_name.presence || "N/A" %>
    <% end %>

    <%# Explanation:: This card shows the specific percentage target used as a performance
      #               benchmark for this rule. It highlights the compliance goal and
      #               works by applying success styling when a value is actively defined.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Meta de Benchmark",
               card_icon: "target",
               card_data: @normative_article.has_benchmark? ? "Definida" : "Não definida",
               card_data_icon: @normative_article.has_benchmark? ? "check" : "x",
               is_success: @normative_article.has_benchmark? do
    %>
      <% if @normative_article.has_benchmark? %>
        <%= number_with_precision(@normative_article.benchmark_target, precision: 2) %>%
      <% else %>
        N/A
      <% end %>
    <% end %>

    <%# Explanation:: This numeric card tracks how many different investment funds are
      #               currently governed by this article. It provides a measure of the
      #               article's impact by counting its associations within the system.
      %>
    <%= render "partials/route/dashboard/card",
               card_title: "Fundos Vinculados",
               card_icon: "coins" do
    %>
      <%= @normative_article.investment_funds.count %>
    <% end %>
  <% end %>

  <%# Explanation:: This table lists every fund that must comply with this normative
    #               article, providing details like CNPJ and custom notes. It is
    #               used for auditing fund relationships and works by iterating through links.
    %>
  <%= render "partials/groups/table-list",
             section_title: "Fundos de Investimento Vinculados",
             collection: @normative_article.investment_fund_articles.includes(investment_fund: :fund_investments),
             action_path: nil,
             action_name: nil,
             headers: [
               "Fundo",
               "CNPJ",
               "Administrador",
               "Observações"
             ],
             column_icons: [
               "layers",
               "id-card",
               "user-cog",
               "info"
             ],
             body_procs: [
               ->(ifa) do
                 content_tag(:div, class: "flex flex-col") do
                   concat link_to(ifa.investment_fund.fund_name, investment_fund_path(ifa.investment_fund), class: "font-medium hover:underline")
                 end
               end,
               ->(ifa) { content_tag(:span, ifa.investment_fund.cnpj, class: "font-mono text-sm") },
               ->(ifa) { content_tag(:span, ifa.investment_fund.administrator_name) },
               ->(ifa) { ifa.note.presence || content_tag(:span, "N/A", class: "text-muted font-mono") }
             ]
  %>

  <%# Explanation:: This metadata section provides an audit trail for the database
    #               record's history. It identifies when the article was first added
    #               and when it was last modified to ensure the data is current.
    %>
  <%= render "partials/route/dashboard/section",
             section_title: "Metadados",
             section_desc: "Informações do sistema",
             columns: 2,
             has_action: false do
  %>

    <%# Explanation:: This info card displays the original registration timestamp of the
      #               article. It calculates how long ago the entry was created and
      #               works by formatting the system date into a readable text block.
      %>
    <%= render "partials/blocks/info-card",
               title: "Data de Criação",
               subtitle: "Quando o artigo foi registrado",
               main_value: formatted_timestamp(@normative_article.created_at),
               sub_value: "#{time_ago_in_words(@normative_article.created_at)} atrás",
               icon_name: "calendar-plus",
               main_color: "secondary"
    %>

    <%# Explanation:: This info card shows the timestamp of the most recent change
      #               made to the article record. it serves as a verification tool
      #               to ensure users are reviewing the most up-to-date regulations.
      %>
    <%= render "partials/blocks/info-card",
               title: "Última Atualização",
               subtitle: "Quando o artigo foi modificado",
               main_value: formatted_timestamp(@normative_article.updated_at),
               sub_value: "#{time_ago_in_words(@normative_article.updated_at)} atrás",
               icon_name: "calendar-check-2",
               main_color: "secondary"
    %>
  <% end %>
<% end %>